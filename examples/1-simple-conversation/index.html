<!-- application_id 20ac1d19-6ea3-4ff0-8831-7e74158cca5d -->
<style>
    #login, #messages {
        width: 80%;
        height: 300px;
    }

    .messages {
        display: none;
    }

    #message {
        width: 80%;
        height: 30px;
        float: left;
    }

    #send {
        height: 30px;
    }
</style>

<section class="login">
    <h1>Login</h1>
    <form id="login">
        <input type="text" id="username" placeholder="Username" required />
        <input type="submit" value="Login" />
    </form>
</section>

<section class="messages">
    <h1>Messages</h1>
    <div id="messages"></div>
    <textarea id="message"></textarea>
    <button id="send">Send</button>
</section>

<script src="./node_modules/nexmo-conversation/dist/conversationClient.js"></script>
<script>
    var USER_JWT = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0OTc4MDQ1MTIsImp0aSI6ImY2OWRjMWUwLTU0NDUtMTFlNy05ZmRkLWYxNTI1ZTc0MjBjZCIsInN1YiI6InRvbSIsImFjbCI6eyJwYXRocyI6eyIvdjEvc2Vzc2lvbnMvKioiOnt9LCIvdjEvdXNlcnMvKioiOnt9LCIvdjEvY29udmVyc2F0aW9ucy8qKiI6e319fSwiYXBwbGljYXRpb25faWQiOiIyMGFjMWQxOS02ZWEzLTRmZjAtODgzMS03ZTc0MTU4Y2NhNWQifQ.VY40wWZGgc3CtjnvCZZu-EodTJCxrdYVmgFJhIFuTjzRSDQW3EfRgsfKMeuDoAng9myI2MSBxz9kV17EPRb_XUICLIFFgTI0XOKF_DYa9gNRtkVmX5r3FUMJ1SeGjPpCZquiQKh5A4-U0u45n2qoR2hZtUNk6cpDKVp28bA-98RSXhaBlojXF1fcHM4RcBvK8Lywnm1_FuLfXQLHg04-mhyZMvmz3alv7X4Gq6eyp24L__EtWiAtWLnRj0bxj_vbPxq2aWoc6AnOsYvYesWPKO4N70iwIOQhfbH6IemJX0nLS_ltLAbWsGizPV-KFHXm4lt3jPB6MBDtgHnSsvc2sg'

    var CONVERSATION_NAME = 'nexmo-chat'

    function authenticate(username) {
        return USER_JWT;
    }

    function login(userToken) {

        var rtc = new ConversationClient({
            debug: false
        });

        rtc.login(userToken).then(function(app) {
            console.log('*** Logged into app', app);

            // Get a list of conversations within the application
            return app.getConversations();
        }).then(function(conversations) {
            console.log('*** Retrieved conversations', conversations);

            // Find the UUID of the conversation we are expecting to join
            var uuid = Object.keys(conversations).find(function(id) {
                return conversations[id].name === CONVERSATION_NAME;
            });

            if (uuid !== undefined) {
                console.log('*** Conversation found', conversations[uuid].name, uuid);

                // Resolve the conversation
                return conversations[uuid];
            }
            else {
                throw new Error('*** Could not find expected conversation', conversation.name);
            }
        }).then(function(conversation) {
            console.log('*** Conversation Member', conversation.me);

            // Bind to events on the conversation
            conversation.on('text', function(sender, message) {
                console.log('*** Message received', sender, message);
                var messagesEl = document.getElementById('messages');
                var text = sender.name + ': ' + message.text + '\n' +
                    messagesEl.innerText;
                messagesEl.innerText = text;
            });
        }).catch(function(error) {
            console.error(error);
        });
    
    }

    document.getElementById('login')
        .addEventListener('submit', function(e) {
            e.preventDefault();

            var username = document.getElementById('username').value;
            var userToken = authenticate(username);
            if(userToken) {
                document.getElementsByClassName('messages')[0].style.display = 'block';
                document.getElementsByClassName('login')[0].style.display = 'none';
                login(userToken);
            }
            else {
                alert(`unknown user "${username}"`);
            }
        }, false);

    document.getElementById('send')
        .addEventListener('click', function() {
            var message = document.getElementById('message').value;
            conversation.sendText(message);
        }, false);
</script>
